package main

import (
	"encoding/json"
	compiler "github.com/OpenFFI/plugin-sdk/compiler/go"
	"os"
	"testing"
)

const idl = `{"idl_filename":"test","idl_extension":".proto","idl_filename_with_extension":"test.proto","idl_full_path":"","modules":[{"name":"Service1","target_language":"go","comment":"Comments for Service1\n","tags":{"openffi_function_path":"package=main","openffi_target_language":"go"},"functions":[{"name":"f1","comment":"F1 comment\nparam1 comment\n","tags":{"openffi_function_path":"function=F1"},"path_to_foreign_function":{"function":"F1","package":"main"},"parameter_type":"Params1","return_values_type":"Return1","parameters":[{"name":"p1","type":"string","comment":"Params1 array of strings\n","tags":null,"is_array":true,"pass_method":""}],"return_values":[{"name":"r1","type":"string","comment":"Return1 string\n","tags":null,"is_array":false,"pass_method":""}]},{"name":"f2","comment":"F2 comment\n","tags":{"openffi_function_path":"function=F2"},"path_to_foreign_function":{"function":"F2","package":"main"},"parameter_type":"Params2","return_values_type":"Return2","parameters":[{"name":"p21","type":"string","tags":null,"is_array":false,"pass_method":""},{"name":"p22","type":"Params1","comment":"Params2 contains Params1\n","tags":null,"is_array":false,"inner_types":[{"name":"p1","type":"string","comment":"Params1 array of strings\n","tags":null,"is_array":true,"pass_method":""}],"pass_method":""},{"name":"p23","type":"map","comment":"Map in params2\n","tags":null,"map_key_type":"string","map_value_type":"int32","is_array":false,"pass_method":""}],"return_values":[{"name":"r21","type":"string","tags":null,"is_array":false,"pass_method":""},{"name":"r22","type":"Return1","tags":null,"is_array":false,"inner_types":[{"name":"r1","type":"string","comment":"Return1 string\n","tags":null,"is_array":false,"pass_method":""}],"pass_method":""}]}]}]}`
const serializationCode = "{\"Service1/test.pb.go\":\"// Code generated by protoc-gen-go. DO NOT EDIT.\\n// versions:\\n// \\tprotoc-gen-go v1.25.0-devel\\n// \\tprotoc        v3.14.0\\n// source: test.proto\\n\\npackage test\\n\\nimport (\\n\\tprotoreflect \\\"google.golang.org/protobuf/reflect/protoreflect\\\"\\n\\tprotoimpl \\\"google.golang.org/protobuf/runtime/protoimpl\\\"\\n\\treflect \\\"reflect\\\"\\n\\tsync \\\"sync\\\"\\n)\\n\\nconst (\\n\\t// Verify that this generated code is sufficiently up-to-date.\\n\\t_ = protoimpl.EnforceVersion(20 - protoimpl.MinVersion)\\n\\t// Verify that runtime/protoimpl is sufficiently up-to-date.\\n\\t_ = protoimpl.EnforceVersion(protoimpl.MaxVersion - 20)\\n)\\n\\ntype Params2 struct {\\n\\tstate         protoimpl.MessageState\\n\\tsizeCache     protoimpl.SizeCache\\n\\tunknownFields protoimpl.UnknownFields\\n\\n\\tP21 string           `protobuf:\\\"bytes,1,opt,name=p21,proto3\\\" json:\\\"p21,omitempty\\\"`\\n\\tP22 *Params1         `protobuf:\\\"bytes,2,opt,name=p22,proto3\\\" json:\\\"p22,omitempty\\\"`\\n\\tP23 map[string]int32 `protobuf:\\\"bytes,3,rep,name=p23,proto3\\\" json:\\\"p23,omitempty\\\" protobuf_key:\\\"bytes,1,opt,name=key,proto3\\\" protobuf_val:\\\"varint,2,opt,name=value,proto3\\\"`\\n}\\n\\nfunc (x *Params2) Reset() {\\n\\t*x = Params2{}\\n\\tif protoimpl.UnsafeEnabled {\\n\\t\\tmi := \\u0026file_test_proto_msgTypes[0]\\n\\t\\tms := protoimpl.X.MessageStateOf(protoimpl.Pointer(x))\\n\\t\\tms.StoreMessageInfo(mi)\\n\\t}\\n}\\n\\nfunc (x *Params2) String() string {\\n\\treturn protoimpl.X.MessageStringOf(x)\\n}\\n\\nfunc (*Params2) ProtoMessage() {}\\n\\nfunc (x *Params2) ProtoReflect() protoreflect.Message {\\n\\tmi := \\u0026file_test_proto_msgTypes[0]\\n\\tif protoimpl.UnsafeEnabled \\u0026\\u0026 x != nil {\\n\\t\\tms := protoimpl.X.MessageStateOf(protoimpl.Pointer(x))\\n\\t\\tif ms.LoadMessageInfo() == nil {\\n\\t\\t\\tms.StoreMessageInfo(mi)\\n\\t\\t}\\n\\t\\treturn ms\\n\\t}\\n\\treturn mi.MessageOf(x)\\n}\\n\\n// Deprecated: Use Params2.ProtoReflect.Descriptor instead.\\nfunc (*Params2) Descriptor() ([]byte, []int) {\\n\\treturn file_test_proto_rawDescGZIP(), []int{0}\\n}\\n\\nfunc (x *Params2) GetP21() string {\\n\\tif x != nil {\\n\\t\\treturn x.P21\\n\\t}\\n\\treturn \\\"\\\"\\n}\\n\\nfunc (x *Params2) GetP22() *Params1 {\\n\\tif x != nil {\\n\\t\\treturn x.P22\\n\\t}\\n\\treturn nil\\n}\\n\\nfunc (x *Params2) GetP23() map[string]int32 {\\n\\tif x != nil {\\n\\t\\treturn x.P23\\n\\t}\\n\\treturn nil\\n}\\n\\ntype Return2 struct {\\n\\tstate         protoimpl.MessageState\\n\\tsizeCache     protoimpl.SizeCache\\n\\tunknownFields protoimpl.UnknownFields\\n\\n\\tR21 string   `protobuf:\\\"bytes,1,opt,name=r21,proto3\\\" json:\\\"r21,omitempty\\\"`\\n\\tR22 *Return1 `protobuf:\\\"bytes,2,opt,name=r22,proto3\\\" json:\\\"r22,omitempty\\\"`\\n}\\n\\nfunc (x *Return2) Reset() {\\n\\t*x = Return2{}\\n\\tif protoimpl.UnsafeEnabled {\\n\\t\\tmi := \\u0026file_test_proto_msgTypes[1]\\n\\t\\tms := protoimpl.X.MessageStateOf(protoimpl.Pointer(x))\\n\\t\\tms.StoreMessageInfo(mi)\\n\\t}\\n}\\n\\nfunc (x *Return2) String() string {\\n\\treturn protoimpl.X.MessageStringOf(x)\\n}\\n\\nfunc (*Return2) ProtoMessage() {}\\n\\nfunc (x *Return2) ProtoReflect() protoreflect.Message {\\n\\tmi := \\u0026file_test_proto_msgTypes[1]\\n\\tif protoimpl.UnsafeEnabled \\u0026\\u0026 x != nil {\\n\\t\\tms := protoimpl.X.MessageStateOf(protoimpl.Pointer(x))\\n\\t\\tif ms.LoadMessageInfo() == nil {\\n\\t\\t\\tms.StoreMessageInfo(mi)\\n\\t\\t}\\n\\t\\treturn ms\\n\\t}\\n\\treturn mi.MessageOf(x)\\n}\\n\\n// Deprecated: Use Return2.ProtoReflect.Descriptor instead.\\nfunc (*Return2) Descriptor() ([]byte, []int) {\\n\\treturn file_test_proto_rawDescGZIP(), []int{1}\\n}\\n\\nfunc (x *Return2) GetR21() string {\\n\\tif x != nil {\\n\\t\\treturn x.R21\\n\\t}\\n\\treturn \\\"\\\"\\n}\\n\\nfunc (x *Return2) GetR22() *Return1 {\\n\\tif x != nil {\\n\\t\\treturn x.R22\\n\\t}\\n\\treturn nil\\n}\\n\\ntype Params1 struct {\\n\\tstate         protoimpl.MessageState\\n\\tsizeCache     protoimpl.SizeCache\\n\\tunknownFields protoimpl.UnknownFields\\n\\n\\tP1 []string `protobuf:\\\"bytes,1,rep,name=p1,proto3\\\" json:\\\"p1,omitempty\\\"`\\n}\\n\\nfunc (x *Params1) Reset() {\\n\\t*x = Params1{}\\n\\tif protoimpl.UnsafeEnabled {\\n\\t\\tmi := \\u0026file_test_proto_msgTypes[2]\\n\\t\\tms := protoimpl.X.MessageStateOf(protoimpl.Pointer(x))\\n\\t\\tms.StoreMessageInfo(mi)\\n\\t}\\n}\\n\\nfunc (x *Params1) String() string {\\n\\treturn protoimpl.X.MessageStringOf(x)\\n}\\n\\nfunc (*Params1) ProtoMessage() {}\\n\\nfunc (x *Params1) ProtoReflect() protoreflect.Message {\\n\\tmi := \\u0026file_test_proto_msgTypes[2]\\n\\tif protoimpl.UnsafeEnabled \\u0026\\u0026 x != nil {\\n\\t\\tms := protoimpl.X.MessageStateOf(protoimpl.Pointer(x))\\n\\t\\tif ms.LoadMessageInfo() == nil {\\n\\t\\t\\tms.StoreMessageInfo(mi)\\n\\t\\t}\\n\\t\\treturn ms\\n\\t}\\n\\treturn mi.MessageOf(x)\\n}\\n\\n// Deprecated: Use Params1.ProtoReflect.Descriptor instead.\\nfunc (*Params1) Descriptor() ([]byte, []int) {\\n\\treturn file_test_proto_rawDescGZIP(), []int{2}\\n}\\n\\nfunc (x *Params1) GetP1() []string {\\n\\tif x != nil {\\n\\t\\treturn x.P1\\n\\t}\\n\\treturn nil\\n}\\n\\ntype Return1 struct {\\n\\tstate         protoimpl.MessageState\\n\\tsizeCache     protoimpl.SizeCache\\n\\tunknownFields protoimpl.UnknownFields\\n\\n\\tR1 string `protobuf:\\\"bytes,1,opt,name=r1,proto3\\\" json:\\\"r1,omitempty\\\"`\\n}\\n\\nfunc (x *Return1) Reset() {\\n\\t*x = Return1{}\\n\\tif protoimpl.UnsafeEnabled {\\n\\t\\tmi := \\u0026file_test_proto_msgTypes[3]\\n\\t\\tms := protoimpl.X.MessageStateOf(protoimpl.Pointer(x))\\n\\t\\tms.StoreMessageInfo(mi)\\n\\t}\\n}\\n\\nfunc (x *Return1) String() string {\\n\\treturn protoimpl.X.MessageStringOf(x)\\n}\\n\\nfunc (*Return1) ProtoMessage() {}\\n\\nfunc (x *Return1) ProtoReflect() protoreflect.Message {\\n\\tmi := \\u0026file_test_proto_msgTypes[3]\\n\\tif protoimpl.UnsafeEnabled \\u0026\\u0026 x != nil {\\n\\t\\tms := protoimpl.X.MessageStateOf(protoimpl.Pointer(x))\\n\\t\\tif ms.LoadMessageInfo() == nil {\\n\\t\\t\\tms.StoreMessageInfo(mi)\\n\\t\\t}\\n\\t\\treturn ms\\n\\t}\\n\\treturn mi.MessageOf(x)\\n}\\n\\n// Deprecated: Use Return1.ProtoReflect.Descriptor instead.\\nfunc (*Return1) Descriptor() ([]byte, []int) {\\n\\treturn file_test_proto_rawDescGZIP(), []int{3}\\n}\\n\\nfunc (x *Return1) GetR1() string {\\n\\tif x != nil {\\n\\t\\treturn x.R1\\n\\t}\\n\\treturn \\\"\\\"\\n}\\n\\nvar File_test_proto protoreflect.FileDescriptor\\n\\nvar file_test_proto_rawDesc = []byte{\\n\\t0x0a, 0x0a, 0x74, 0x65, 0x73, 0x74, 0x2e, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x22, 0x94, 0x01, 0x0a,\\n\\t0x07, 0x50, 0x61, 0x72, 0x61, 0x6d, 0x73, 0x32, 0x12, 0x10, 0x0a, 0x03, 0x70, 0x32, 0x31, 0x18,\\n\\t0x01, 0x20, 0x01, 0x28, 0x09, 0x52, 0x03, 0x70, 0x32, 0x31, 0x12, 0x1a, 0x0a, 0x03, 0x70, 0x32,\\n\\t0x32, 0x18, 0x02, 0x20, 0x01, 0x28, 0x0b, 0x32, 0x08, 0x2e, 0x50, 0x61, 0x72, 0x61, 0x6d, 0x73,\\n\\t0x31, 0x52, 0x03, 0x70, 0x32, 0x32, 0x12, 0x23, 0x0a, 0x03, 0x70, 0x32, 0x33, 0x18, 0x03, 0x20,\\n\\t0x03, 0x28, 0x0b, 0x32, 0x11, 0x2e, 0x50, 0x61, 0x72, 0x61, 0x6d, 0x73, 0x32, 0x2e, 0x50, 0x32,\\n\\t0x33, 0x45, 0x6e, 0x74, 0x72, 0x79, 0x52, 0x03, 0x70, 0x32, 0x33, 0x1a, 0x36, 0x0a, 0x08, 0x50,\\n\\t0x32, 0x33, 0x45, 0x6e, 0x74, 0x72, 0x79, 0x12, 0x10, 0x0a, 0x03, 0x6b, 0x65, 0x79, 0x18, 0x01,\\n\\t0x20, 0x01, 0x28, 0x09, 0x52, 0x03, 0x6b, 0x65, 0x79, 0x12, 0x14, 0x0a, 0x05, 0x76, 0x61, 0x6c,\\n\\t0x75, 0x65, 0x18, 0x02, 0x20, 0x01, 0x28, 0x05, 0x52, 0x05, 0x76, 0x61, 0x6c, 0x75, 0x65, 0x3a,\\n\\t0x02, 0x38, 0x01, 0x22, 0x37, 0x0a, 0x07, 0x52, 0x65, 0x74, 0x75, 0x72, 0x6e, 0x32, 0x12, 0x10,\\n\\t0x0a, 0x03, 0x72, 0x32, 0x31, 0x18, 0x01, 0x20, 0x01, 0x28, 0x09, 0x52, 0x03, 0x72, 0x32, 0x31,\\n\\t0x12, 0x1a, 0x0a, 0x03, 0x72, 0x32, 0x32, 0x18, 0x02, 0x20, 0x01, 0x28, 0x0b, 0x32, 0x08, 0x2e,\\n\\t0x52, 0x65, 0x74, 0x75, 0x72, 0x6e, 0x31, 0x52, 0x03, 0x72, 0x32, 0x32, 0x22, 0x19, 0x0a, 0x07,\\n\\t0x50, 0x61, 0x72, 0x61, 0x6d, 0x73, 0x31, 0x12, 0x0e, 0x0a, 0x02, 0x70, 0x31, 0x18, 0x01, 0x20,\\n\\t0x03, 0x28, 0x09, 0x52, 0x02, 0x70, 0x31, 0x22, 0x19, 0x0a, 0x07, 0x52, 0x65, 0x74, 0x75, 0x72,\\n\\t0x6e, 0x31, 0x12, 0x0e, 0x0a, 0x02, 0x72, 0x31, 0x18, 0x01, 0x20, 0x01, 0x28, 0x09, 0x52, 0x02,\\n\\t0x72, 0x31, 0x62, 0x06, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x33,\\n}\\n\\nvar (\\n\\tfile_test_proto_rawDescOnce sync.Once\\n\\tfile_test_proto_rawDescData = file_test_proto_rawDesc\\n)\\n\\nfunc file_test_proto_rawDescGZIP() []byte {\\n\\tfile_test_proto_rawDescOnce.Do(func() {\\n\\t\\tfile_test_proto_rawDescData = protoimpl.X.CompressGZIP(file_test_proto_rawDescData)\\n\\t})\\n\\treturn file_test_proto_rawDescData\\n}\\n\\nvar file_test_proto_msgTypes = make([]protoimpl.MessageInfo, 5)\\nvar file_test_proto_goTypes = []interface{}{\\n\\t(*Params2)(nil), // 0: Params2\\n\\t(*Return2)(nil), // 1: Return2\\n\\t(*Params1)(nil), // 2: Params1\\n\\t(*Return1)(nil), // 3: Return1\\n\\tnil,             // 4: Params2.P23Entry\\n}\\nvar file_test_proto_depIdxs = []int32{\\n\\t2, // 0: Params2.p22:type_name -\\u003e Params1\\n\\t4, // 1: Params2.p23:type_name -\\u003e Params2.P23Entry\\n\\t3, // 2: Return2.r22:type_name -\\u003e Return1\\n\\t3, // [3:3] is the sub-list for method output_type\\n\\t3, // [3:3] is the sub-list for method input_type\\n\\t3, // [3:3] is the sub-list for extension type_name\\n\\t3, // [3:3] is the sub-list for extension extendee\\n\\t0, // [0:3] is the sub-list for field type_name\\n}\\n\\nfunc init() { file_test_proto_init() }\\nfunc file_test_proto_init() {\\n\\tif File_test_proto != nil {\\n\\t\\treturn\\n\\t}\\n\\tif !protoimpl.UnsafeEnabled {\\n\\t\\tfile_test_proto_msgTypes[0].Exporter = func(v interface{}, i int) interface{} {\\n\\t\\t\\tswitch v := v.(*Params2); i {\\n\\t\\t\\tcase 0:\\n\\t\\t\\t\\treturn \\u0026v.state\\n\\t\\t\\tcase 1:\\n\\t\\t\\t\\treturn \\u0026v.sizeCache\\n\\t\\t\\tcase 2:\\n\\t\\t\\t\\treturn \\u0026v.unknownFields\\n\\t\\t\\tdefault:\\n\\t\\t\\t\\treturn nil\\n\\t\\t\\t}\\n\\t\\t}\\n\\t\\tfile_test_proto_msgTypes[1].Exporter = func(v interface{}, i int) interface{} {\\n\\t\\t\\tswitch v := v.(*Return2); i {\\n\\t\\t\\tcase 0:\\n\\t\\t\\t\\treturn \\u0026v.state\\n\\t\\t\\tcase 1:\\n\\t\\t\\t\\treturn \\u0026v.sizeCache\\n\\t\\t\\tcase 2:\\n\\t\\t\\t\\treturn \\u0026v.unknownFields\\n\\t\\t\\tdefault:\\n\\t\\t\\t\\treturn nil\\n\\t\\t\\t}\\n\\t\\t}\\n\\t\\tfile_test_proto_msgTypes[2].Exporter = func(v interface{}, i int) interface{} {\\n\\t\\t\\tswitch v := v.(*Params1); i {\\n\\t\\t\\tcase 0:\\n\\t\\t\\t\\treturn \\u0026v.state\\n\\t\\t\\tcase 1:\\n\\t\\t\\t\\treturn \\u0026v.sizeCache\\n\\t\\t\\tcase 2:\\n\\t\\t\\t\\treturn \\u0026v.unknownFields\\n\\t\\t\\tdefault:\\n\\t\\t\\t\\treturn nil\\n\\t\\t\\t}\\n\\t\\t}\\n\\t\\tfile_test_proto_msgTypes[3].Exporter = func(v interface{}, i int) interface{} {\\n\\t\\t\\tswitch v := v.(*Return1); i {\\n\\t\\t\\tcase 0:\\n\\t\\t\\t\\treturn \\u0026v.state\\n\\t\\t\\tcase 1:\\n\\t\\t\\t\\treturn \\u0026v.sizeCache\\n\\t\\t\\tcase 2:\\n\\t\\t\\t\\treturn \\u0026v.unknownFields\\n\\t\\t\\tdefault:\\n\\t\\t\\t\\treturn nil\\n\\t\\t\\t}\\n\\t\\t}\\n\\t}\\n\\ttype x struct{}\\n\\tout := protoimpl.TypeBuilder{\\n\\t\\tFile: protoimpl.DescBuilder{\\n\\t\\t\\tGoPackagePath: reflect.TypeOf(x{}).PkgPath(),\\n\\t\\t\\tRawDescriptor: file_test_proto_rawDesc,\\n\\t\\t\\tNumEnums:      0,\\n\\t\\t\\tNumMessages:   5,\\n\\t\\t\\tNumExtensions: 0,\\n\\t\\t\\tNumServices:   0,\\n\\t\\t},\\n\\t\\tGoTypes:           file_test_proto_goTypes,\\n\\t\\tDependencyIndexes: file_test_proto_depIdxs,\\n\\t\\tMessageInfos:      file_test_proto_msgTypes,\\n\\t}.Build()\\n\\tFile_test_proto = out.File\\n\\tfile_test_proto_rawDesc = nil\\n\\tfile_test_proto_goTypes = nil\\n\\tfile_test_proto_depIdxs = nil\\n}\\n\",\"Service1/test.proto\":\"syntax = \\\"proto3\\\";\\n\\n\\nmessage Params2\\n{\\n  \\tstring p21 = 1;Params1 p22 = 2;map\\u003cstring,int32\\u003e p23 = 3;\\n}\\n\\nmessage Return2\\n{\\n  \\tstring r21 = 1;Return1 r22 = 2;\\n}\\n\\nmessage Params1\\n{\\n  \\trepeated string p1 = 1;\\n}\\n\\nmessage Return1\\n{\\n  \\tstring r1 = 1;\\n}\\n\"}"


//--------------------------------------------------------------------
func TestGuest(t *testing.T){

	def, err := compiler.NewIDLDefinition(idl)
	if err != nil{
		t.Fatal(err)
		return
	}

	serializationCodeMap := make(map[string]string)
	err = json.Unmarshal([]byte(serializationCode), &serializationCodeMap)
	if err != nil{
		t.Fatal(err)
		return
	}

	cmp := NewCompiler(def, serializationCodeMap, ".")
	outputFileName, err := cmp.CompileGuest()
	if err != nil{
		t.Fatal(err)
		return
	}

	err = os.Remove(outputFileName)
	if err != nil{
		t.Fatal(err)
		return
	}

}
//--------------------------------------------------------------------
func TestHost(t *testing.T){

	def, err := compiler.NewIDLDefinition(idl)
	if err != nil{
		t.Fatal(err)
		return
	}

	serializationCodeMap := make(map[string]string)
	err = json.Unmarshal([]byte(serializationCode), &serializationCodeMap)
	if err != nil{
		t.Fatal(err)
		return
	}


	cmp := NewCompiler(def, serializationCodeMap, ".")
	outputFileName, err := cmp.CompileHost()
	if err != nil{
		t.Fatal(err)
		return
	}

	err = os.Remove(outputFileName)
	if err != nil{
		t.Fatal(err)
		return
	}

}
//--------------------------------------------------------------------