
# build openffi.compiler.python3 Go dynamic library
FILE(GLOB go_sources "${CMAKE_CURRENT_LIST_DIR}/*.go")

find_program(GOEXEC go)
if(NOT GOEXEC)
	message(FATAL "Go not found - Skipping build of Go support")
else()

# build
add_custom_target(openffi.compiler.go ALL)
add_custom_command(TARGET openffi.compiler.go
					DEPENDS ${go_sources}
					WORKING_DIRECTORY ${CMAKE_CURRENT_LIST_DIR}
					COMMAND ${GOEXEC} build -buildmode=c-shared -gcflags=-shared -o ${CMAKE_CURRENT_BINARY_DIR}/openffi.compiler.go${CMAKE_SHARED_LIBRARY_SUFFIX} ${GO_SRCS}
					COMMENT "Building openffi.compiler.go compiler plugin")


# Unitest
add_test(NAME compiler_go_gotest
		COMMAND ${GOEXEC} test
		WORKING_DIRECTORY ${CMAKE_CURRENT_LIST_DIR})

endif()